# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands

- `npm run dev` - Start compilation in watch mode
- `npm run build` - Build production version (with TypeScript checks)
- `npm version patch|minor|major` - Bump version
- `npm run format` - Format code with Prettier
- `npm run format:check` - Check code formatting with Prettier
- `npm run lint` - Lint code with ESLint
- `npm run lint:fix` - Lint and fix code with ESLint
- `npm run typecheck` - Run TypeScript type checking
- `npm run test` - Run tests with Vitest
- `npm run test:watch` - Run tests in watch mode
- `npm run docs:dev` - Start VitePress documentation server
- `npm run docs:build` - Build documentation
- `task build` - Build and optionally copy to plugin directory (if PLUGIN_DIR is set)
- `task pr` - Prepare for PR (format, lint, type check, and test)
- `task release` - Release a new minor version (includes format, lint, type check, and test)

Recommended workflow: After running tests and fixing any issues, run `npm run build` to catch TypeScript or bundling errors that tests may not surface.

## Code Style

- **TypeScript:** Use strict typing (noImplicitAny, strictNullChecks)
- **React:** Use functional components with explicit props interfaces
- **JSX:** Use React JSX syntax with function components
- **Imports:** Group by: 1) external packages, 2) local files; sort alphabetically within groups
- **Naming:** PascalCase for components/classes/interfaces, camelCase for functions/variables
- **Types:** Define in lib/types.ts with explicit interfaces; use TypeScript generics where appropriate
- **Error Handling:** Use nullable types with default values or early returns; avoid unchecked nulls
- **Components:** Place reusable UI components in lib/components/; use props interfaces
- **Domain Logic:** Place domain-specific code in lib/domains/
- **Views:** Place UI views in lib/views/; extend BaseView where applicable
- **Formatting:** Use consistent indentation (2 spaces), trailing commas, and semi-colons
- **State Management:** Use React hooks (useState) for component state
- **CSS:** Prefix all styles with plugin namespace; place component styles in lib/styles/components/
- **File Structure:** Keep code aligned with domain separation (domains, components, views)

## Architecture

- **Plugin Structure:** Obsidian plugin with React components for D&D UI elements
- **Code Block Processors:** Each View class processes specific YAML code blocks (ability, skills, stats, etc.)
- **State Management:** Uses KeyValueStore with JsonDataStore for persistent state across sessions
- **Component Architecture:**
  - Views: Handle code block parsing and rendering (extend BaseView)
  - Components: React components for UI elements
  - Domains: Business logic for D&D mechanics (abilities, skills, combat)
  - Services: KV store for state persistence and event bus for communication
- **Rendering:** Views register markdown post-processors that transform YAML into interactive React components
- **Plugin Settings:** Configurable color scheme and state file path in settings tab
- **Event System:** Uses message bus (msgbus) for communication between components and frontmatter changes
- **Frontmatter Integration:** Automatically syncs with Obsidian frontmatter for character data like proficiency bonus and level
- **View Registration Pattern:** Each view extends BaseView and implements:
  - `registerView()`: Registers code block processor with plugin
  - `render()`: Transforms parsed YAML data into React components
  - State persistence handled automatically via KV store integration
- **State Persistence:**
  - In-memory cache with automatic disk persistence
  - Scoped by view type and element ID
  - State file location configurable in plugin settings
- **Template System:** Handlebars-style templating for dynamic content (e.g., {{dex_mod}} in ability descriptions)
- **D&D Mechanics:** Implements 5e rules for ability modifiers, proficiency bonuses, skill calculations

## Testing

- **Framework:** Vitest with Node environment
- **Test Files:** Place tests alongside source files with `.test.ts` extension
- **Coverage:** Configured to exclude config files, main.ts, and build outputs
- **Running Tests:**
  - All tests: `npm run test`
  - Watch mode: `npm run test:watch`
  - Single test file: `npm run test path/to/file.test.ts`
  - Pattern matching: `npm run test -- --grep "pattern"`
- **Test Patterns:** Mock external dependencies (e.g., MockDataStore), use TypeScript generics for type safety

## Development Workflow

- **Plugin Development:** Set PLUGIN_DIR environment variable to auto-copy built files to Obsidian plugin directory
- **Documentation:** VitePress documentation in `/docs` with examples and component references
- **State File:** Plugin creates `.dnd-ui-toolkit-state.json` (configurable) for persistent component state
